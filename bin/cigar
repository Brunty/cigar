#!/usr/bin/env php
<?php

error_reporting(0);

$autoloadLocations = [
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../../autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/vendor/autoload.php'
];

foreach ($autoloadLocations as $autoloadFile) {
    if (file_exists($autoloadFile)) {
        require $autoloadFile;
        break;
    }
}

use Brunty\Cigar\AsyncChecker;
use Brunty\Cigar\Outputter;
use Brunty\Cigar\Parser;

array_shift($argv);
$help = isset($argv[0]) && $argv[0] === '--help';

if($help) {
    $content = <<<HELP

\e[33mUsage:\e[0m
  cigar [options]

\e[33mOptions:\e[0m
      \e[32m--quiet\e[0m                    Do not output any message


HELP;
    echo $content;
    exit(0);
}

if( ! file_exists('.cigar.json')) {
    Outputter::writeErrorLine('Could not find .cigar.json file');
    exit(1);
}

$quiet = isset($argv[0]) && $argv[0] === '--quiet';
try {
    $domains = (new Parser)->parse('.cigar.json');
} catch(\Throwable $e) {
    Outputter::writeErrorLine('Unable to parse .cigar.json file');
    exit(1);
}

$results = (new AsyncChecker())->check($domains);
$passed = (new Outputter)->outputResults($results, $quiet);

if ( ! $passed) {
    exit(1);
}

exit(0);
