#!/usr/bin/env php
<?php

define('CIGAR_VERSION', '2.0.0');

foreach (['/../../..', '/../..', '/../vendor', '/vendor'] as $autoloadFileDirectory) {
    if (file_exists(__DIR__ . $autoloadFileDirectory . '/autoload.php')) {
        /** @psalm-suppress UnresolvableInclude */
        require __DIR__ . $autoloadFileDirectory . '/autoload.php';
        break;
    }
}

use Brunty\Cigar\AsyncChecker;
use Brunty\Cigar\ConsoleColours;
use Brunty\Cigar\EchoWriter;
use Brunty\Cigar\ExitCode;
use Brunty\Cigar\Input;
use Brunty\Cigar\InputOption;
use Brunty\Cigar\InputOptions;
use Brunty\Cigar\JsonWriter;
use Brunty\Cigar\Output;
use Brunty\Cigar\ConfigParser;
use Brunty\Cigar\QuietWriter;
use Brunty\Cigar\SystemTimer;

$timer = new SystemTimer();
$start = $timer->now();

$inputOptions = new InputOptions([
    'config' => InputOption::create('config', 'f', InputOption::VALUE_REQUIRED, 'Use the specified config file instead of the default cigar.json file'),

    'auth' => InputOption::create('auth', 'a', InputOption::VALUE_REQUIRED, 'Authorization header "<type> <credentials>"'),
    'header' => InputOption::create('header', 'h', InputOption::VALUE_REQUIRED, 'Custom header "<name>: <value>", can be passed multiple times to send multiple headers'),
    'insecure' => InputOption::create('insecure', 'i', InputOption::VALUE_NONE, 'Allow invalid SSL certificates'),
    'url' => InputOption::create('url', 'u', InputOption::VALUE_REQUIRED, 'Base URL for checks, e.g. https://example.org/'),

    'connect-timeout' => InputOption::create('connect-timeout', 'c', InputOption::VALUE_REQUIRED, 'Connect Timeout in seconds'),
    'timeout' => InputOption::create('timeout', 't', InputOption::VALUE_REQUIRED, 'Timeout in seconds'),

    'quiet' => InputOption::create('quiet', 'q', InputOption::VALUE_NONE, 'Do not output any message'),
    'json' => InputOption::create('json', 'j', InputOption::VALUE_NONE, 'Output JSON'),

    'help' => InputOption::create('help', '', InputOption::VALUE_NONE, 'Show the help message'),
    'version' => InputOption::create('version', '', InputOption::VALUE_NONE, 'Print the version of Cigar'),
]);

$input = new Input($inputOptions, getopt($inputOptions->shortCodes, $inputOptions->longCodes));

$output = new Output(
    $input->getOption('quiet')
        ? new QuietWriter()
        : ($input->getOption('json') ? new JsonWriter() : new EchoWriter()),
    $timer,
);

$consoleCyan = ConsoleColours::cyan();
$consoleYellow = ConsoleColours::yellow();
$consoleGrey = ConsoleColours::grey();
$consoleReset = ConsoleColours::reset();

if ($input->getOption('help')) {
    echo <<<HELP

{$consoleYellow}Usage:{$consoleReset}
  cigar [options]

{$output->generateHelpOutputForOptions($inputOptions)}

Created by Matt Brunt
E: matt@brunty.me
M: brunty.social/@brunty
T: twitter.com/Brunty
G: github.com/brunty/cigar

HELP;
    exit(ExitCode::SUCCESS->value);
}

if ($input->getOption('version')) {
    $version = CIGAR_VERSION;
    echo <<<VERSION
  ____ ___ ____    _    ____
 / ___|_ _/ ___|  / \  |  _ \
| |    | | |  _  / _ \ | |_) |
| |___ | | |_| |/ ___ \|  _ <
 \____|___\____/_/   \_\_| \_\

{$consoleGrey}The simple smoke testing tool.{$consoleReset}

Version {$consoleCyan}$version{$consoleReset}

For additional help use {$consoleCyan}--help{$consoleReset}


VERSION;
    exit(ExitCode::SUCCESS->value);
}

$configFile = $input->getOption('config') ?: 'cigar.json';
$baseUrl = $input->getOption('url') ?: null;

if ( ! file_exists($configFile)) {
    $output->writeErrorLine('Could not find configuration file: ' . $configFile);
    exit(ExitCode::FAILURE->value);
}

try {
    $configParser = new ConfigParser(
        $baseUrl,
        $input->getOption('connect-timeout') ?: null,
        $input->getOption('timeout') ?: null,
    );
    $domains = $configParser->parse($configFile);
} catch (Throwable $e) {
    $output->writeErrorLine(sprintf('Unable to parse Cigar JSON file: %s', $e->getMessage()));
    exit(ExitCode::FAILURE->value);
}

$results = (new AsyncChecker(
    ! $input->getOption('insecure'),
    $input->getOption('auth') ?: null,
    $input->getOption('header') ?: [],
))->check($domains);

$output->outputResults($results, $start);

exit($results->hasPassed() ? ExitCode::SUCCESS->value : ExitCode::FAILURE->value);
